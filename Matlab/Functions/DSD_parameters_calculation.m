%+
%
% Author:
%zhangtc

%Description:
%calculating the patameters discribing DSD,noting that diameter and speed
%of raindrops obtained from the raw data were revised.
% History:
% 2021-04-14
%DSD_parameters_calculation

function [rainflag, ND, RR, LWC, Z, Dm,Nw, Delt_m, mu, lamd, N0]...
    = DSD_parameters_calculation(putu)
load('E:\CODE\OTTparsivel2_mat\DSD_parameters.mat','speed_coe');
load('E:\CODE\OTTparsivel2_mat\DSD_parameters.mat','central_dia_qc');
load('E:\CODE\OTTparsivel2_mat\DSD_parameters.mat','central_speed');
putu(:,[1:2,24:32]) = 0;
temp_putu = putu .* speed_coe;
clear putu

rainflag = 0;
ND = zeros(32);
RR = 0;
LWC = 0;
Dm = 0;
Z = 0;
Nw = 0;
Delt_m = 0;
mu = 0;
lamd = 0;
N0 = 0;
if sum(sum(temp_putu)) > 10
    rainflag = 1;
    for di = 3:23
        for vj = 1:32
            ND(di) = ND(di) + temp_putu(vj,di)./(0.0054.*60 .* central_speed(vj).*dia_bandwidth_qc(di));
            RR = RR + 6 * pi * (1e-4) .* temp_putu(vj,di) .* central_dia_qc(di)^3 ./ (0.0054.*60);
            LWC = LWC + pi/6 * (1e-3) .* temp_putu(vj,di) .* central_dia_qc(di)^3 ./ (0.0054.*60.*central_speed(vj));
        end
        M2 = M2 + ND(di) .*central_dia_qc(di)^2 .* dia_bandwidth_qc(di);
        M3 = M3 + ND(di) .*central_dia_qc(di)^3 .* dia_bandwidth_qc(di);
        M4 = M4 + ND(di) .*central_dia_qc(di)^4 .* dia_bandwidth_qc(di);
        M6 = M6 + ND(di) .*central_dia_qc(di)^6 .* dia_bandwidth_qc(di);
    end
    
    Dm = M4/M3;
    Z = M6;
    Nw = 4^4 ./ pi .* 1e3 .* LWC ./ (Dm ^4);
    
    ita = (M4^2)./(M2 .* M6);
    mu = (7-11*ita-sqrt(ita^2+14*ita+1))./(2*(ita-1));
    lamd = sqrt((M2 * gamma(mu+5))./(M4 * gamma(mu+3)));
    N0 = M6*lamd^(mu+6+1)./gamma(mu+6+1);
    temp = 0;
    for di = 3:23
        temp = temp + (central_dia_qc(di)-Dm)^2 .* ...
            ND .*central_dia_qc(di)^3 .* dia_bandwidth_qc(di);
    end
    Delt_m = temp ./ M3;
    clear temp
    if RR <0.01
        rainflag = 0;
        ND(:) = 0;
        RR = 0;
        LWC = 0;
        Dm = 0;
        Z = 0;
        Nw = 0;
        Delt_m = 0;
        mu = 0;
        lamd = 0;
        N0 = 0;
    end
    
end


end

% speed_coe = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0;...
%     0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1;...
%     0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1;...
%     0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1;...
%     0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1;...
%     0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1;...
%     0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1;...
%     0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1;...
%     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1;...
%     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1;...
%     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1;...
%     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;...
%     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];